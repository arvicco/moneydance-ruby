<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <title>Primer on JRuby and Moneydance Methods</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="description"
          content="Introduction to JRuby programming within Moneydance.">
    <meta name=keywords content="JRuby, Ruby, Moneydance, documentation, primer">
    <meta name="author" content="Ric Werme, Arvicco">

    <style type="text/css">
        body {
            margin-top: 1.0em;
            background-color: #edf7ed;
            font-family: "Helvetica,Arial,FreeSans";
            color: #000000;
        }

        #container {
            margin: 0 auto;
            width: 700px;
        }

        h1 {
            font-size: 3.8em;
            color: #120812;
            margin-bottom: 3px;
        }

        h1 .small {
            font-size: 0.4em;
        }

        h1 a {
            text-decoration: none
        }

        h2 {
            font-size: 1.5em;
            color: #120812;
        }

        h3 {
            text-align: center;
            color: #120812;
        }

        a {
            color: #120812;
        }

        .description {
            font-size: 1.2em;
            margin-bottom: 30px;
            margin-top: 30px;
            font-style: italic;
        }

        .download {
            float: right;
        }

        pre {
            background: #120812;
            color: #fff;
            padding: 10px;
        }

        hr {
            border: 0;
            width: 80%;
            border-bottom: 1px solid #aaa
        }

        .footer {
            text-align: center;
            padding-top: 30px;
            font-style: italic;
        }
    </style>

</head>
<body>

<h2>Welcome to Moneydance Ruby</h2>
This page has notes on using <a href="http://arvicco.github.com/moneydance-ruby">
Moneydance JRuby extension</a> and introduces the
important Moneydance methods. The documentation is pretty thin, but it tries
to present things in the order that most people will use with special
focus on the methods used to produce reports. While
<a href=http://moneydance.com/dev/ext_api_docs/index.html>
    Moneydance API documentation</a> contains minimal definitions of all
classes and methods, this page concentrates on most common and useful methods
and explains how to best use them in Ruby scripts.

<p>Many of the Moneydance classes and methods can be accessed with just a
    few commands on the Ruby console (GUI version of IRB with few add-ons),
    and you can cut and paste many of the examples below to check out the methods in your
    environment. The methods below were choosen for their utility in writing report
    generators. They will be useful in most other programming too, such as those that
    modify Moneydance data. Once you understand the methods here, many others will be
    simple to learn.</p>

<h2>Running Ruby scripts</h2>

Once you have the Moneydance Ruby extension installed, you can run Ruby programs through
two mechanisms, the Ruby console or from the command line. Console is great for
testing your ideas and running one-liners, as well as generally learning your way
around Moneydance classes and methods. You can load/execute Ruby source files from
console too, using "Load file" button at the bottom. Any output or errors generated by
loaded code is fed into the console, and you can continue your IRB session normally
once the code is loaded.

<p>You can also run your scripts inside Moneydance environment via special command line
    mode that this program supports:
</p>
<p>You can also run your Ruby scripts via command like this (Unix): </p>
<pre>$ moneydance moneydance:fmodule:ruby:file?/path/to/script.rb </pre>

<p>On OSX (assuming you installed Moneydance into /Applications), use:
</p>
<pre>$ /Applications/Moneydance.app/Contents/MacOS/JavaApplicationStub \
  -invoke_and_quit moneydance:fmodule:ruby:file?/path/to/script.rb </pre>

<h2>Moneydance Ruby is JRuby</h2>

Notes on how JRuby plays with Java...

<h2>Accessing Moneydance data from Ruby</h2>

Constants and such...

<h2>Class <a
        href=http://moneydance.com/dev/ext_api_docs/com/moneydance/apps/md/model/RootAccount.html>rootAccount</a>
</h2>

<a name=getRootAccount></a>
Pretty much any Moneydance JRuby program will start with something like:

<blockquote>
    <pre>ra = moneydance.getRootAccount()</pre>
</blockquote>

<p>The methods special to rootAccount are not very useful for writing reports,
    the methods for the generic account class are the useful ones. However,
    there are a couple:

<ul>
    <a name=getHighestAccountNum></a><a name=getAccountById></a><a
        name=getAccountByName></a>

    <p>
    <li>getHighestAccountNum()
    <li>Account getAccountById(int id)
    <li>Account getAccountByName(string name)<br>
        Accounts have ID numbers that range from 0 to getHighestAccountNum().
        getAccountById() is mainly used in loops that scan all the accounts.
        getAccountByName() is defined in the generic Account class, It's listed
        here because it is frequently accessed through the root account.

        <blockquote><pre>
>>> ra = moneydance.getRootAccount()
>>> ra.getHighestAccountNum()
112
>>> acct = ra.getAccountById(112)
>>> acct
Elemental Holdings:Radium Arc Lamps
>>> acct = ra.getAccountByName('elemental holdings')
</pre>
        </blockquote>

        <a name=getTransactionSet>
            <p>
            <li>getTransactionSet()<br>
                This provides access to the class TransactionSet, which is used to get
                transactions for an account.

                <blockquote><pre>

</pre>
                </blockquote>

</ul>

<h2>Class <a
        href=http://moneydance.com/dev/ext_api_docs/com/moneydance/apps/md/model/Account.html>Account</a>
</h2>

Reports generally involve accounts or transactions, and transactions involve
accounts, so the account class is important. You can get access to an account
in the Ruby console:

<blockquote><pre>
>>> ra = moneydance.getRootAccount()
>>> acct = ra.getAccountByName('checking')
>>> print repr(acct)
Checking
>>> acct
Checking
</pre>
</blockquote>

<p>Useful methods:

<ul>
    <a name=getAccountName>
        <p>
        <li>string getAccountName()<br>

            There are ways of getting accounts where you don't know the name or
            you may not be certain about which characters are upper or lower case,
            this lets you get the exact name.

            <blockquote><pre>
>>> acct.getAccountName()
'Checking'
</pre>
            </blockquote>

            <a name=getFullAccountName><a name=getAllAccountNames><a name=getDepth>
                <p>
                <li>getFullAccountName()
                <li>getAllAccountNames()
                <li>getDepth()<br>
                    These are related and most useful when dealing with subaccounts.
                    <blockquote><pre>
>>> pg = ra.getAccountByName('personal:groceries')
>>> pg.getFullAccountName()
'Personal:Groceries'
>>> pg.getAllAccountNames()
array(['Personal', 'Groceries'], java.lang.String)
>>> pg.getAllAccountNames()[0]
'Personal'
>>> pg.getAllAccountNames()[1]
'Groceries'
>>> pg.getDepth()
2
>>> acct.getDepth()
1
>>> ra.getDepth()
0
</pre>
                    </blockquote>

                    <a name=getAccountNum>
                        <p>
                        <li>getAccountNum()<br>

                            Accounts can be accessed by a numeric ID. You won't see this
                            in the Moneydance
                            windows, but it is useful at times.

                            <blockquote><pre>
>>> acct.getAccountNum() 
1
</pre>
                            </blockquote>

                            <a name=getBalance>
                                <p>
                                <li>getBalance()
                                <li>getStartBalance()<br>
                                    Balances are kept as integers, scaled to the account's
                                    currency or significant
                                    places of a share. Integer math avoids roundoff errors
                                    typical of floating
                                    point numbers with decimal fractions. For US bank
                                    accounts, a balance of
                                    3541L is $35.41.

                                    <blockquote><pre>
>>> acct.getBalance()
3541L
>>> acct.getStartBalance()
0L
</pre>
                                    </blockquote>

</ul>

<h2>Transactions: class

    <a href=http://moneydance.com/dev/ext_api_docs/com/moneydance/apps/md/model/ParentTxn.html>ParentTxn</a>
    and
    <a href=http://moneydance.com/dev/ext_api_docs/com/moneydance/apps/md/model/SplitTxn.html>SplitTxn</a>
</h2>

Transactions involve at least two accounts, the account you entered the
transaction into and the account it referenced. If you used a split, then
it will reference several accounts.

<p>To get all the transactions associated with an account, you need to have
    the rootAccount search for them. Consider this checking account with a
    short register:

<pre>
Date       Chk  Desc    Account         Payment   Deposit   Balance 
1/01/2005  Dep  Bossco  Bonus                    1,000.00  1,000.00
1/03/2005       Banke   Savings          100.00              900.00
1/07/2005  1    CG      Groceries         20.00              880.00
1/15/2005  2    Sitgo   - 2 splits -      30.00              850.00
 Split 1:       Lunch   Personal:Dining   10.00
 Split 2:       Gas     Automotive:Fuel   20.00
1/31/2005  ATM  Cash    ATM Withdrawal   100.00              750.00
</pre>

<blockquote><pre>
>>> txns = ra.getTransactionSet().getTransactionsForAccount(acct).getAllTxns()
>>> txns
com.moneydance.apps.md.model.TxnSet$TransactionEnumerator@1c9f8fb
>>> for txn in txns:
...     print repr(txn)
... 
[ParentTxn(12) desc=Cash; val=-10000; stat= ; #splits=1; chk=ATM; ...
[ParentTxn(10) desc=Bank; val=-10000; stat= ; #splits=1; chk=; ...
[ParentTxn(8) desc=CG; val=-2000; stat= ; #splits=1; chk=1; ...
[ParentTxn(6) desc=Sitgo; val=-3000; stat= ; #splits=2; chk=2; ...
[ParentTxn(3) desc=Bossco; val=100000; stat= ; #splits=1; chk=Dep; ...
</pre>
</blockquote>

<p>The list of attributes displayed isn't complete and Moneydance doesn't
    let you access them directly, e.g. txn.val won't work. The attributes are
    accessed by various methods. Here are all the fields displayed above for
    the transactions with 2 splits with the method a program can use to get the
    values or a close relative:


<ul>
    <li>ParentTxn(6) <b>txn.getTxnId()</b>
        <ul>
            <li> desc=Sitgo; <b>txn.getDescription()</b>
            <li> val=-3000; <b>txn.getValue()</b>
            <li> stat= ; <b>txn.getStatusChar(), txn.getStatus()</b>

            <li> #splits=2; <b>txn.getOtherTxnCount()</b>
            <li> chk=2; <b>txn.getCheckNumber(), txn.getCheckNumAsInt()</b>
            <li> acct=Checking; <b>txn.getAccount()</b>
            <li> date=20050115; <b>txn.getDate()</b>
            <li> splits=[

            <li>SplitTxn(4): <b>sxn = txn.getOtherTxn(0), sxn.getTxnId()</b>
                <ul>
                    <li> desc=Lunch; <b>sxn.getDescription()</b>
                    <li> val=1000; <b>sxn.getValue()</b>
                    <li> stat= ; <b>sxn.getStatusChar(), sxn.getStatus()</b>
                    <li> acct=Personal:Dining; <b>sxn.getAccount()</b>

                    <li> rate=1.0; <b>sxn.getRate()</b>
                    <li> amt=-1000; <b>sxn.getAmount()</b>
                    <li> val=1000; <b>sxn.getValue()</b>
                </ul>
            <li> ], [
            <li>SplitTxn(5) <b>sxn = txn.getOtherTxn(1), sxn.getTxnId()</b>

                <ul>
                    <li> desc=Gas;
                    <li> val=2000;
                    <li> stat= ;
                    <li> acct=Automotive:Fuel;
                    <li> rate=1.0;
                    <li> amt=-2000;
                    <li> val=2000;
                </ul>
            <li> ], ; ]

        </ul>
</ul>

<p>Other useful methods include the following. Methods prefixed with
    <tt>txn.</tt> apply to the parent transaction (class ParentTxn) and
    <tt>sxn.</tt> apply to the first split transaction (class SplitTxn).

<ul>
    <a name=getMemo>
        <p>
        <li>txn.getMemo()<br>
            <blockquote><pre>
>>> txn.getMemo()
'Eat here and get gas.'
</pre>
            </blockquote>

            <a name=getOtherTxnCount>
                <p>
                <li>getOtherTxnCount()<br>
                    From the parent transaction, this returns the number of splits. From
                    the
                    split, I think this always returns 1.
                    <blockquote><pre>
>>> txn.getOtherTxnCount()
2
>>> sxn.getOtherTxnCount()
1
</pre>
                    </blockquote>

                    <a name=getParentTxn>
                        <p>
                        <li>getParentTxn()<br>
                            From either the parent or split transaction, this return the
                            parent
                            transaction.
                            <blockquote><pre>
>>> txn.getParentTxn()
[ParentTxn(6) desc=Sitgo; val=-3000; ...
>>> sxn.getParentTxn()
[ParentTxn(6) desc=Sitgo; val=-3000; ...
</pre>
                            </blockquote>

                            <a name=getTransferType>
                                <p>
                                <li>getTransferType()<br>
                                    This returns a string describing the type of the
                                    transfer between
                                    parent and split accounts.

                                    <blockquote><pre>
>>> txn.getTransferType()
'xfrtp_bank'
>>> sxn.getTransferType()
'xfrtp_bank'
>>> txn.TRANSFER_TYPE_BANK 
'xfrtp_bank'
</pre>
                                    </blockquote>

</ul>

<h2>Class <a
        href=http://moneydance.com/dev/ext_api_docs/com/moneydance/apps/md/model/InvestmentAccount.html>InvestmentAccount</a>
</h2>

There isn't much difference between banking accounts and investment accounts
within Moneydance. For that matter, there isn't much difference between
foreign currency holdings and security holdings in that both are held in units
with a value that fluctuates over time.

<p>Suppose we have an investment account called Elemental Holdings,
    which has two stocks from these transactions:

<blockquote><pre>

  Security: Itanium Mining
   Date     Dir     Shares   $/sh     Value    Balance
2005/04/01  Buy    10.0000  40.00      $400.00    10.0000

  Security: Radium Arc Lamps
   Date     Dir     Shares   $/sh     Value    Balance
2005/03/14  Buy   100.0000   3.14      $314.00   100.0000
   Commission:                           $0.15
</pre>
</blockquote>

If we look at these via Mondydance:

<blockquote><pre>
>>> acct = ra.getAccountByName('elemental holdings')
>>> acct.getBalance()
0L
>>> txns = ra.getTransactionSet().getTransactionsForAccount(acct).getAllTxns() 
>>> for txn in txns:
...      print repr(txn)
... 
[ParentTxn(21) desc=Buy Shares; val=-40000; #splits=1; chk=; date=20050401; ...
[SplitTxn(18) desc=Elemental Holdings; val=40000; rate=1.0; amt=-40000; val=40000;  ]
[SplitTxn(16) desc=Elemental Holdings; val=31415; rate=1.0; amt=-31415; val=31415;  ]
[ParentTxn(15) desc=Buy Shares; val=-31415; #splits=2; chk=; date=20050314; ...
</pre>
</blockquote>


The last transaction has two splits, let's take a closer look at it as we
look at some important methods.

<blockquote><pre>
>>> ts = ra.getTransactionSet()
>>> txn =ts.getTxnByID(15)
>>> txn.getSplitCount()
2
>>> sxn0 = txn.getSplit(0)
>>> sxn1 = txn.getSplit(1)
</pre>
</blockquote>

<ul>

    <p>
    <li>getAccount()<br>
        Nothing new here, but note how the transaction links to the various accounts.

        <blockquote><pre>
>>> txn.getAccount()
Elemental Holdings
>>> sxn0.getAccount()
Elemental Holdings:Radium Arc Lamps
>>> sxn1.getAccount()
Investment:Trading Commission
</pre>
        </blockquote>

        <a name=getValue>
            <p>
            <li>getValue()<br>
                While this is defined in the parent transaction, here it is the
                change in the amount of this account's shares (or currency) in
                some fraction of a share (or currency unit). This is explained in
                the CurrencyType section below.

                <blockquote><pre>
>>> txn.getValue()
-31415L
>>> sxn0.getValue()
1000000L
>>> sxn1.getValue()
15L
</pre>
                </blockquote>

                <a name=getAmount>
                    <p>
                    <li>getAmount()<br>

                        This is the amount of a split in the units of the parent
                        transaction, in
                        this case 1/100ths of a dollar (i.e. pennies).

                        <blockquote><pre>
>>> txn.getAmount()
Traceback (innermost last):
  File "console", line 1, in ?
                            AttributeError: getAmount
                            >>> sxn0.getAmount()
                            -31400L
                            >>> sxn1.getAmount()
                            -15L
</pre>
                        </blockquote>

                        <a name=getRate>
                            <p>
                            <li>getRate()<br>
                                This is the value divided by the amount, and is used to
                                convert between
                                the two units.

                                <blockquote><pre>
>>> sxn0.getRate()
31.84713375796178
>>> float(sxn0.getValue()) / sxn0.getAmount()
-31.84713375796178
>>> sxn1.getRate()
1.0
</pre>
                                </blockquote>

</ul>

<h2>Class <a
        href=http://moneydance.com/dev/ext_api_docs/com/moneydance/apps/md/model/CurrencyType.html>CurrencyType</a>
</h2>

Moneydance tracks currencies and share values in CurrencyType classes.
As implied above, these holding sizes are tracked as multiples of some
fraction of a share. The fraction size, currency name, and
many other attributes are tracked within this class.

<p>You can get to an account's currency type from the Ruby console:

<pre>
>>> acct = ra.getAccountByName('elemental holdings:itanium mining')
>>> ct = acct.getCurrencyType()
>>> chk = ra.getAccountByName('checking')
>>> cct = chk.getCurrencyType()
</pre>

<ul>
    <a name=getName>
        <p>
        <li>getName()
        <li>getIDString()<br>
            These return names of the security or currency.

            <blockquote><pre>
>>> ct.getName() 
'Itanium Mining'
>>> ct.getIDString() 
'^itm'
>>> cct.get()
'US Dollar'
>>> cct.getIDString()
'USD'
</pre>
            </blockquote>

            <a name=getDecimalPlaces>
                <p>
                <li>getDecimalPlaces()<br>
                    This returns the number of decimal places in share amounts. By
                    representing
                    shares as long integers, moneydance avoids most roundoff errors.

                    <blockquote><pre>
>>> ct.getDecimalPlaces()
4
>>> cct.getDecimalPlaces()
2
</pre>
                    </blockquote>

                    <a name=format><a name=formatSemiFancy><a name=formatFancy>
                        <p>
                        <li>format(amt, decimalChar)
                        <li>formatSemiFancy(amt, decimalChar)
                        <li>formatFancy(amt, decimalChar)<br>
                            These are convenience methods to print amounts in
                            user-oriented formats.
                            Amt is in fractions of a share or the smallest unit of the
                            currency.
                            DecimalChar is '.' to print American-style numbers, ',' to
                            print European.

                            <blockquote><pre>
>>> ct.format(123456789L, '.')
'12345.6789'
>>> ct.formatSemiFancy(123456789L, '.')
'12,345.6789'
>>> ct.formatFancy(123456789L, ',')
12.345,6789 itm Shares'
>>> cct.formatFancy(123456789L, '.')
'$ 1,234,567.89'
</pre>
                            </blockquote>

                            <a name=getRawRate>
                                <p>
                                <li>getRawRate()<br>
                                    This returns the current conversion rate to convert
                                    some amount in the
                                    base currency to the number of shares. The number of
                                    shares divided by
                                    the rate is the value of the shares. For example, the
                                    itm conversion
                                    rate is 4.0, so one share is worth 10,000/4.0 = 2,500
                                    cents, $25.00.

                                    <blockquote><pre>
>>> ct.getRawRate()
4.0
>>> cct.getRawRate()
1.0
</pre>
                                    </blockquote>

                                    <a name=getRawRateByDate>
                                        <p>
                                        <li>getRawRateByDate()<br>
                                            The CurrencyType class includes any value
                                            history entered for a security
                                            or foreign currency. For ITM, the history has
                                            these date, value pairs:

                                            <blockquote><pre>
04/01/2005  $40.00
09/01/2005  $30.00
10/01/2005  $25.00
</pre>
                                            </blockquote>

                                            Moneydance date/time values are tracked as
                                            longs in 1,000ths of a day.
                                            Day zero follows Unix/Linux/Posix practice, so
                                            it's easy to work with
                                            date/time values with Ruby's time module.

                                            <blockquote><pre>
>>> import time
>>> dt = (2005, 10, 1, 0, 0, 0, 0, 0, 0)
>>> ct.getRawRateByDate(long(time.mktime(dt)) * 1000L)
3.333333333333333
>>> dt = (2005, 10, 2, 0, 0, 0, 0, 0, 0)
>>> ct.getRawRateByDate(long(time.mktime(dt)) * 1000L)
4.0
</pre>
                                            </blockquote>

</ul>

<p>
</body>
</html>